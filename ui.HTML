<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Financial Evaluation Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(to bottom, #fff, #ff9953);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="mb-8">
        
        <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">FinEval: LLM evaluation for Financial Reasoning</h1>
        <p class="text-gray-500 mt-1">Judge Model (Gemini-2.5-PRO) evaluates accuracy and reasoning quality.</p>
    </header>

    <main id="app" class="flex flex-col lg:flex-row gap-6">

        <!-- LEFT PANEL: Task Selection & Input Control -->
        <div class="lg:w-1/3 bg-white p-6 rounded-xl shadow-lg h-fit">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2 text-indigo-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 0-9.25 10c0 5.5 4.5 10 10 10s10-4.5 10-10C22.25 4.5 17.75 2 12 2z"/><path d="M12 6v6l4 2"/></svg>
                Select Evaluation Task
            </h2>

            <label for="task-selector" class="block text-sm font-medium text-gray-700 mb-2">Evaluation Scenario</label>
            <select id="task-selector" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 mb-4">
                <option value="" disabled selected>Search or Select Task ID / Scenario Name...</option>
                <option value="task_revenue_forecast">Task 001: Q4 Revenue Forecast</option>
                <option value="task_debt_equity">Task 002: Debt-to-Equity Calculation</option>
            </select>
            
            <button id="evaluate-button" class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:opacity-50" disabled>
                Run Evaluation
            </button>

            <!-- Input Context -->
            <div class="mt-6 pt-4 border-t border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Financial Context</h3>
                <textarea id="task-context" rows="6" readonly class="w-full p-4 text-sm bg-gray-100 border border-gray-300 rounded-xl resize-none text-gray-700 leading-relaxed min-h-[180px] max-h-[280px] overflow-y-auto" placeholder="Select a task to view its context..."></textarea>
            </div>
            
            <!-- Question -->
            <div class="mt-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Question</h3>
                <textarea id="task-question" rows="4" readonly class="w-full p-4 text-sm bg-gray-100 border border-gray-300 rounded-xl resize-none text-gray-700 leading-relaxed min-h-[140px] max-h-[240px] overflow-y-auto" placeholder="Select a task to view the question..."></textarea>
            </div>

            <!-- Ground Truth section removed as requested -->
        </div>

        <!-- RIGHT PANEL: Evaluation Report -->
        <div class="lg:w-2/3 bg-white p-6 rounded-xl shadow-lg min-h-[500px]">
            <h2 id="report-heading" class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2h6v6m-6-6-8 8m0 0v-4m0 4h4M9 14l-4 4m0 0v-4m0 4h4m4-10-8 8m8-8v4m-8 8v4m-4-4h-4m4 4h4m4-4h4"/></svg>
                Evaluation Results â€¢ Judge Model (Gemini-2.5-PRO)
            </h2>
            
            <div id="loading-spinner" class="hidden text-center py-10">
                <div class="animate-spin inline-block w-8 h-8 border-4 rounded-full border-t-indigo-500 border-indigo-200"></div>
                <p class="mt-3 text-indigo-600">Running Gemini 3 and Fin-o1-14B models...</p>
            </div>

            <div id="error-message" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                <p class="font-bold">Error during evaluation:</p>
                <p id="error-text"></p>
            </div>


            <div id="results-content" class="hidden">
                <!-- Score Card Summary -->
                <div id="score-card-summary" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Cards will be injected here -->
                </div>

                <!-- Detailed Output & Judge Verdict -->
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Detailed Verdict Comparison</h3>
                <div id="detail-comparison" class="w-full">
                    <!-- The 3-column comparison table will be injected here -->
                </div>
            </div>
            
            <div id="initial-message" class="text-center py-20 text-gray-500">
                <p class="text-lg">Select a task from the left panel and click "Run Evaluation" to see the results.</p>
            </div>
        </div>
    </main>

    <script>
        // Global Constants
        const GEMINI_MODEL = 'gemini-2.5-pro';
        let API_KEY = "";
        function resolveApiKey() {
            const q = new URLSearchParams(window.location.search).get('key') || '';
            const ls = (typeof localStorage !== 'undefined' && localStorage.getItem('GEMINI_API_KEY')) || '';
            const win = (typeof window !== 'undefined' && window.GEMINI_API_KEY) || '';
            return q || ls || win || '';
        }

        let TASKS = {};
        async function loadTasksFromJsonl() {
            const res = await fetch('data/financial-reasoning-datasets/train.jsonl');
            const txt = await res.text();
            const lines = txt.split('\n').filter(l => l.trim().length > 0);
            TASKS = {};
            taskSelector.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.disabled = true;
            placeholder.selected = true;
            placeholder.textContent = 'Select a dataset item...';
            taskSelector.appendChild(placeholder);
            lines.forEach((line, idx) => {
                try {
                    const obj = JSON.parse(line);
                    const key = `test_${idx+1}`;
                    const name = `Test ${idx+1}`;
                    TASKS[key] = {
                        id: String(idx+1),
                        name,
                        context: String(obj.context || ''),
                        question: String(obj.question || ''),
                        refAnswer: String(obj.answer || ''),
                        refReasoning: String(obj.reasoning || ''),
                    };
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = `${name}: ${(obj.question || '').slice(0, 60)}`;
                    taskSelector.appendChild(opt);
                } catch {}
            });
        }

        // DOM elements
        const taskSelector = document.getElementById('task-selector');
        const evaluateButton = document.getElementById('evaluate-button');
        const taskContext = document.getElementById('task-context');
        const taskQuestion = document.getElementById('task-question'); // New element
        // We no longer display refAnswer/Reasoning, but store the reference text for the prompt/table.
        let refAnswer = ''; 
        let refReasoning = ''; 

        const reportHeading = document.getElementById('report-heading');
        const scoreCardSummary = document.getElementById('score-card-summary');
        const detailComparison = document.getElementById('detail-comparison');
        const resultsContent = document.getElementById('results-content');
        const initialMessage = document.getElementById('initial-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        let selectedTaskKey = '';

        // --- Utility Functions for API ---

        /** Fetches content from the Gemini API with exponential backoff. */
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    }
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API error: ${response.status} ${response.statusText}. Body: ${errorBody}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // Otherwise, the loop continues for backoff
                }
            }
        }

        // --- Core Evaluation Logic (The Judge Model) ---

        function buildJudgePrompt(task) {
            const systemPrompt = `You are the Judge Model (Gemini-2.5-PRO). Generate candidate outputs for two models 'Gemini 3' and 'Fin-o1-14B' for the given task, then evaluate them against the ground truth.
            Scoring:
            - Answer Score (%): numeric accuracy versus ground truth answer
            - Reasoning Score (%): logical consistency and completeness
            - Overall Score: (Answer Score * 0.6) + (Reasoning Score * 0.4)
            Return a JSON array of objects with keys: modelName, answer, reasoning, answerScore, reasoningScore, overallScore, flag, rationale.`;
            const userQuery = `TASK CONTEXT:\n${task.context}\n\nQUESTION:\n${task.question}\n\nGROUND TRUTH:\nAnswer: ${task.refAnswer}\nReasoning: ${task.refReasoning}\n\nModel Names to evaluate: Gemini 3, Fin-o1-14B`;
            return { systemPrompt, userQuery };
        }

        async function runEvaluation(taskKey) {
            const task = TASKS[taskKey];
            if (!task) return;

            initialMessage.classList.add('hidden');
            resultsContent.classList.add('hidden');
            errorMessage.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            evaluateButton.disabled = true;

            try {
                // Run both models in parallel
                const [g3, fino1] = await Promise.all([
                    fetch('/api/gemini3', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ context: task.context, question: task.question })
                    }).then(r => r.json()),
                    fetch('/api/fino1', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ context: task.context, question: task.question })
                    }).then(r => r.json())
                ]);

                // Get judge evaluations for both models
                const [judgeG3, judgeFino1] = await Promise.all([
                    fetch('/api/judge', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            context: task.context,
                            question: task.question,
                            gt_answer: task.refAnswer,
                            gt_reasoning: task.refReasoning,
                            model_answer: g3.answer,
                            model_reasoning: g3.reasoning,
                        })
                    }).then(r => r.json()),
                    fetch('/api/judge', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            context: task.context,
                            question: task.question,
                            gt_answer: task.refAnswer,
                            gt_reasoning: task.refReasoning,
                            model_answer: fino1.answer,
                            model_reasoning: fino1.reasoning,
                        })
                    }).then(r => r.json())
                ]);

                const pct = (s) => { const m = String(s||'').match(/([\d.]+)/); return m ? Number(m[1]) : 0; };
                const judgeResults = [
                    {
                        modelName: 'Gemini 3',
                        answer: g3.answer || '',
                        reasoning: g3.reasoning || '',
                        overallScore: pct(judgeG3.overall),
                        answerScore: pct(judgeG3.answer),
                        reasoningScore: pct(judgeG3.reasoning),
                        flag: '',
                        rationale: judgeG3.verdict || '',
                    },
                    {
                        modelName: 'Fin-o1-14B',
                        answer: fino1.answer || '',
                        reasoning: fino1.reasoning || '',
                        overallScore: pct(judgeFino1.overall),
                        answerScore: pct(judgeFino1.answer),
                        reasoningScore: pct(judgeFino1.reasoning),
                        flag: '',
                        rationale: judgeFino1.verdict || '',
                    }
                ];
                renderResults(task, judgeResults);
            } catch (e) {
                console.error('Evaluation failed:', e);
                errorText.textContent = e.message || String(e);
                errorMessage.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
                evaluateButton.disabled = false;
            }
        }

        function renderDetailedTable(task, combinedResults, maxScore) {
            const modelNames = Object.keys(combinedResults);
            
            // Header Cells (Model Names + Ground Truth)
            let headerCells = '';
            modelNames.forEach(name => {
                headerCells += `<div class="p-3 font-semibold text-lg text-indigo-700">${name}</div>`;
            });
            headerCells += `<div class="p-3 font-semibold text-lg text-green-700">Accurate Answer</div>`;
            
            const tableGridClass = "grid grid-cols-[150px_1fr_1fr_1fr] divide-x divide-gray-200 border-t border-b border-gray-200";

            let tableHtml = `
                <div class="rounded-xl overflow-hidden shadow-lg border border-gray-200">
                    <!-- Table Header -->
                    <div class="grid grid-cols-[150px_1fr_1fr_1fr] divide-x divide-gray-200 bg-gray-100 font-bold text-sm uppercase tracking-wider text-gray-700">
                        <div class="p-3"></div> <!-- Empty top-left cell -->
                        ${headerCells}
                    </div>

                    <!-- Row 1: Final Answer -->
                    <div class="${tableGridClass} hover:bg-gray-50">
                        <div class="p-3 font-medium text-gray-800">Answer</div>
                        ${modelNames.map(name => `
                            <div class="p-3 text-sm font-mono text-gray-900">
                                ${combinedResults[name].answer}
                            </div>
                        `).join('')}
                        <div class="p-3 text-lg font-extrabold text-green-700">${task.refAnswer}</div>
                    </div>

                    <!-- Row 2: Reasoning -->
                    <div class="${tableGridClass} hover:bg-gray-50">
                        <div class="p-3 font-medium text-gray-800">Reasoning</div>
                        ${modelNames.map(name => `
                            <div class="p-3 text-xs italic text-gray-600">${combinedResults[name].reasoning}</div>
                        `).join('')}
                        <div class="p-3 text-xs text-green-600">${task.refReasoning}</div>
                    </div>

                    <!-- Row 3: Judge Verdict (Scores & Rationale) -->
                    <div class="${tableGridClass} bg-white">
                        <div class="p-3 font-medium text-gray-800">Judge Verdict</div>
                        ${modelNames.map(name => {
                            const result = combinedResults[name];
                            const isHigh = result.overallScore === maxScore;
                            const verdictBg = isHigh ? 'bg-green-50' : 'bg-yellow-50';
                            const accuracyColor = result.answerScore < 85 ? 'text-red-600' : 'text-green-600';
                            const consistencyColor = result.reasoningScore < 85 ? 'text-red-600' : 'text-green-600';
                            
                            return `
                                <div class="p-3 text-sm border-l-4 ${verdictBg} ${isHigh ? 'border-green-500' : 'border-yellow-500'}">
                                    <p class="font-bold mb-1">Overall Score: <span class="text-base">${result.overallScore}%</span></p>
                                    <div class="flex justify-between text-xs">
                                        <span>Answer Score:</span>
                                        <span class="font-bold ${accuracyColor}">${result.answerScore}%</span>
                                    </div>
                                    <div class="flex justify-between text-xs mb-2">
                                        <span>Reasoning Score:</span>
                                        <span class="font-bold ${consistencyColor}">${result.reasoningScore}%</span>
                                    </div>
                                    <p class="text-xs italic text-gray-700 mt-2">${result.rationale}</p>
                                </div>
                            `;
                        }).join('')}
                        <div class="p-3 text-sm text-gray-400 bg-gray-50">N/A (Reference)</div>
                    </div>
                </div>
            `;
            detailComparison.insertAdjacentHTML('beforeend', tableHtml);
        }

        function renderResults(task, judgeResults) {
            // Find the highest score to apply the 'high-score' styling
            const maxScore = Math.max(...judgeResults.map(r => r.overallScore));
            
            scoreCardSummary.innerHTML = '';
            detailComparison.innerHTML = '';
            resultsContent.classList.remove('hidden');

            const combinedResults = {};
            judgeResults.forEach(judge => {
                const modelName = judge.modelName;
                combinedResults[modelName] = { ...judge };
            });

            // 1. Render Summary Cards
            judgeResults.forEach(result => {
                // Determine if this is the highest score
                const isHigh = result.overallScore === maxScore;
                
                const highClass = isHigh ? 'border-green-400 bg-green-50' : 'border-yellow-300 bg-yellow-50';
                const scoreColor = isHigh ? 'text-green-600' : 'text-yellow-600';
                const flagColor = result.flag.includes('Critical') ? 'text-red-500 font-semibold' : 'text-gray-500';

                const summaryHtml = `
                    <div class="p-5 rounded-xl border-2 ${highClass} transition duration-300 hover:shadow-xl">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${result.modelName}</h3>
                        <div class="flex justify-between items-center my-3">
                            <span class="text-sm text-gray-600">Overall Score:</span>
                            <div class="text-4xl font-extrabold ${scoreColor}">${result.overallScore}%</div>
                        </div>
                        <div class="text-sm font-medium mb-1">
                            Answer Score: <span class="font-bold">${result.answerScore}%</span>
                        </div>
                        <div class="text-sm font-medium mb-3">
                            Reasoning Score: <span class="font-bold">${result.reasoningScore}%</span>
                        </div>
                        <p class="text-sm ${flagColor} flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                            ${result.flag}
                        </p>
                    </div>
                `;
                scoreCardSummary.insertAdjacentHTML('beforeend', summaryHtml);
            });

            // 2. Render Detailed Comparison Table
            renderDetailedTable(task, combinedResults, maxScore);
        }

        // --- Event Handlers ---

        taskSelector.addEventListener('change', () => {
            selectedTaskKey = taskSelector.value;
            const task = TASKS[selectedTaskKey];

            if (task) {
                // Update UI fields
                taskContext.value = task.context;
                taskQuestion.value = task.question; 
                
                // Store reference data internally for use in the table/prompt
                refAnswer = task.refAnswer;
                refReasoning = task.refReasoning;
                
                evaluateButton.disabled = false;
                
                // Reset UI state
                initialMessage.classList.remove('hidden');
                resultsContent.classList.add('hidden');
                errorMessage.classList.add('hidden');
                reportHeading.textContent = `Evaluation Results: Task ${task.id}`;
            }
        });


        evaluateButton.addEventListener('click', () => {
            if (selectedTaskKey) {
                // The main function is now asynchronous
                runEvaluation(selectedTaskKey);
            }
        });

        // Initialize with default message
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTasksFromJsonl();
        });
    </script>
</body>
</html>